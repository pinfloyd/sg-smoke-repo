name: L5 External Admission Gate (MANDATORY / fail-closed)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch: {}

jobs:
  l5_gate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: External L5 Gate (contract-correct; pinned; fail-closed)
        shell: bash
        env:
          L5_AUTH_URL: ${{ secrets.L5_AUTH_URL }}
          L5_PUBKEY_SHA256: ${{ secrets.L5_PUBKEY_SHA256 }}
          L5_PIN_IMAGE_DIGEST: ${{ secrets.L5_PIN_IMAGE_DIGEST }}
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          set -euo pipefail

          echo "BASE_SHA=${BASE_SHA}"
          echo "HEAD_SHA=${HEAD_SHA}"

          if [ -z "${L5_AUTH_URL:-}" ]; then echo "MISSING_SECRET:L5_AUTH_URL"; exit 1; fi
          if [ -z "${L5_PUBKEY_SHA256:-}" ]; then echo "MISSING_SECRET:L5_PUBKEY_SHA256"; exit 1; fi
          if [ -z "${L5_PIN_IMAGE_DIGEST:-}" ]; then echo "MISSING_SECRET:L5_PIN_IMAGE_DIGEST"; exit 1; fi
          if [ -z "${BASE_SHA:-}" ] || [ -z "${HEAD_SHA:-}" ]; then echo "MISSING_PR_SHAS"; exit 1; fi

          git fetch --no-tags --prune --depth=200 origin "${BASE_SHA}" || true
          git fetch --no-tags --prune --depth=200 origin "${HEAD_SHA}" || true

          python3 - << 'PY'
import json, os, re, subprocess, sys, urllib.request

auth = os.environ["L5_AUTH_URL"].rstrip("/")
pin_pk = os.environ["L5_PUBKEY_SHA256"].strip().lower()
pin_img = os.environ["L5_PIN_IMAGE_DIGEST"].strip()
base = os.environ["BASE_SHA"]
head = os.environ["HEAD_SHA"]

diff = subprocess.check_output(["git","diff","--unified=0", f"{base}..{head}"], text=True, errors="replace")

facts=[]
cur=None
new=None

for ln in diff.splitlines():
  if ln.startswith("+++ b/"):
    cur = ln[6:]
    continue
  m = re.match(r"^\@\@ -\d+(?:,\d+)? \+(\d+)(?:,(\d+))? \@\@", ln)
  if m:
    new = int(m.group(1))
    continue
  if cur is None or new is None:
    continue
  if ln.startswith("+") and not ln.startswith("+++"):
    facts.append({"file":cur,"line":new,"added":ln[1:]})
    new += 1
  elif ln.startswith("-") and not ln.startswith("---"):
    continue
  else:
    if not ln.startswith("\\"):
      new += 1

req_obj = {
  "intent": {
    "action_type": "GIT_COMMIT_DIFF",
    "payload": {"diff_facts": facts}
  }
}

data = json.dumps(req_obj, ensure_ascii=False, separators=(",",":")).encode("utf-8")
req = urllib.request.Request(auth + "/admit", data=data, headers={"Content-Type":"application/json"}, method="POST")

try:
  with urllib.request.urlopen(req, timeout=25) as r:
    body = r.read().decode("utf-8","replace")
except Exception as e:
  print("L5_CALL_FAILED", str(e))
  sys.exit(1)

print("L5_RAW_RESPONSE_BEGIN")
print(body[:4000])
print("L5_RAW_RESPONSE_END")

try:
  o = json.loads(body)
except Exception:
  print("L5_BAD_JSON_RESPONSE")
  sys.exit(1)

# Pin checks (fail-closed)
pk = (o.get("authority_pubkey_sha256") or "").strip().lower()
img = (o.get("image_digest") or "").strip()
if pk != pin_pk:
  print("PIN_FAIL_AUTH_PUBKEY_SHA256", pk, pin_pk)
  sys.exit(1)
if img != pin_img:
  print("PIN_FAIL_IMAGE_DIGEST", img, pin_img)
  sys.exit(1)

# Decision extraction (support multiple shapes)
decision = ""
if isinstance(o.get("decision"), str):
  decision = o["decision"].strip()
sp = o.get("signed_payload") or {}
if not decision and isinstance(sp.get("decision"), str):
  decision = sp["decision"].strip()
sr = o.get("signed_record") or {}
if not decision and isinstance(sr.get("decision"), str):
  decision = sr["decision"].strip()

print("DECISION=" + decision)

if decision != "ALLOW":
  findings = []
  if isinstance(sp, dict) and isinstance(sp.get("findings"), list):
    findings = sp.get("findings")
  print("FINDINGS_COUNT=" + str(len(findings)))
  if findings:
    print(json.dumps(findings[:5], ensure_ascii=False))
  sys.exit(1)

print("L5_ALLOW_OK")
PY
